name: Build Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup vcpkg
        run: vcpkg integrate install

      - name: Set version name
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "release") {
            echo "name=${{ github.event.release.tag_name }}" >> $env:GITHUB_OUTPUT
          } else {
            # Use short hash (7 chars) for manual builds
            $shortSha = "${{ github.sha }}".Substring(0, 7)
            echo "name=$shortSha" >> $env:GITHUB_OUTPUT
          }

      - name: Cache TFLite build
        id: cache-tflite
        uses: actions/cache@v4
        with:
          path: |
            HandTracker/libs/tensorflow/tflite_build/install
            HandTracker/libs/tensorflow/tflite_build/MinSizeRel
            HandTracker/libs/tensorflow/tflite_build/_deps/abseil-cpp-build
          key: tflite-vs2022-static-${{ hashFiles('scripts/build_tflite.cmd') }}

      - name: Apply TFLite patch
        if: steps.cache-tflite.outputs.cache-hit != 'true'
        run: git apply scripts/tflite-prune.patch --directory=HandTracker/libs/tensorflow

      - name: Build TFLite
        if: steps.cache-tflite.outputs.cache-hit != 'true'
        run: scripts\build_tflite.cmd
        shell: cmd

      - name: Cache OpenCV build
        id: cache-opencv
        uses: actions/cache@v4
        with:
          path: HandTracker/libs/opencv/build/install
          key: opencv-4130-vs2022-static-${{ hashFiles('scripts/build_opencv.cmd') }}

      - name: Build OpenCV
        if: steps.cache-opencv.outputs.cache-hit != 'true'
        run: scripts\build_opencv.cmd
        shell: cmd

      - name: Build Release
        run: msbuild ParticleSaturn.slnx /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:OpenCVRuntime=vc17 /p:VcpkgEnableManifest=true /p:AppVersion=${{ steps.version.outputs.name }} /m

      - name: Build ReleaseStatic
        run: msbuild ParticleSaturn.slnx /p:Configuration=ReleaseStatic /p:Platform=x64 /p:PlatformToolset=v143 /p:OpenCVRuntime=vc17 /p:VcpkgEnableManifest=true /p:AppVersion=${{ steps.version.outputs.name }} /m

      - name: Prepare Release artifacts
        run: |
          $releaseDir = "release_artifacts"
          New-Item -ItemType Directory -Force -Path $releaseDir

          # Copy Release build files
          Copy-Item "bin/x64/Release/ParticleSaturn.exe" $releaseDir/
          Copy-Item "bin/x64/Release/HandTracker.dll" $releaseDir/
          Copy-Item "bin/x64/Release/glfw3.dll" $releaseDir/

          # Copy model files
          Copy-Item "HandTracker/models/palm_detection_full.tflite" $releaseDir/
          Copy-Item "HandTracker/models/hand_landmark_full.tflite" $releaseDir/

      - name: Create 7z archive (ultra compression)
        run: 7z a -t7z -mx=9 ParticleSaturn-${{ steps.version.outputs.name }}.7z ./release_artifacts/*

      - name: Create zip archive (maximum compression)
        run: 7z a -tzip -mx=9 ParticleSaturn-${{ steps.version.outputs.name }}.zip ./release_artifacts/*

      - name: Upload artifact (Release)
        uses: actions/upload-artifact@v4
        with:
          name: ParticleSaturn-${{ steps.version.outputs.name }}
          path: release_artifacts/

      - name: Upload artifact (Static)
        uses: actions/upload-artifact@v4
        with:
          name: ParticleSaturn-Static-${{ steps.version.outputs.name }}
          path: bin/x64/Release_Static/ParticleSaturn.exe

      - name: Upload PDB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PDB-${{ steps.version.outputs.name }}
          path: |
            bin/x64/Release/ParticleSaturn.pdb
            bin/x64/Release/HandTracker.pdb
            bin/x64/Release_Static/ParticleSaturn.pdb

      - name: Upload Release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ParticleSaturn-${{ steps.version.outputs.name }}.7z
            ParticleSaturn-${{ steps.version.outputs.name }}.zip
            bin/x64/Release_Static/ParticleSaturn.exe

      - name: Upload PDB to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin/x64/Release_Static/ParticleSaturn.pdb
